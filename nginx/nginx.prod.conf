server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # Редирект всего HTTP трафика на HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # --- Пути к SSL-сертификатам ---
    # ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    # include /etc/letsencrypt/options-ssl-nginx.conf;
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    client_max_body_size 50M;

    # --- Корневая директория Laravel ---
    # Определяется один раз для всего бэкенда
    root /var/www/html/public;
    index index.php;

    # --- Сжатие ---
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # =======================================================
    # == Обработка статики Vue (SPA) и Laravel
    # =======================================================

    # Статика Laravel (например, загруженные файлы)
    location /storage {
        try_files $uri =404;
    }

    # Статика Vue (assets) с агрессивным кэшированием
    # Vite обычно добавляет хэш к именам файлов, поэтому их можно кэшировать "навсегда"
    location /assets {
        root /usr/share/nginx/html; # Указываем root для Vue
        try_files $uri =404;
        expires 1y;
        add_header Cache-Control "public";
    }

    # Главная страница SPA (Vue)
    # Этот блок должен идти перед обработкой PHP
    location / {
        root /usr/share/nginx/html; # Указываем root для Vue
        try_files $uri /index.html;
    }

    # =======================================================
    # == Обработка динамики (PHP и WebSockets)
    # =======================================================

    # API и Horizon
    # Все запросы, начинающиеся с /api/ или /horizon/, отправляются на PHP
    location ~ ^/(api|horizon)/ {
        try_files $uri /index.php?$query_string;
    }

    # WebSocket (Reverb)
    location /app {
        proxy_pass http://laravel_websockets:6001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    # Обработка ТОЛЬКО index.php через FPM. Это безопаснее.
    location = /index.php {
        include fastcgi_params;
        fastcgi_pass laravel_app:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # Явно запрещаем доступ к другим .php файлам
    location ~ \.php$ {
        return 404;
    }

    # Запрещаем доступ к системным файлам
    location ~ /\.ht {
        deny all;
    }
}